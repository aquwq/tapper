<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pixel Rogue World</title>

<style>
html,body{
  margin:0;
  background:#87c38f;
  font-family:monospace;
  overflow:hidden;
}
#ui{
  position:fixed;
  top:6px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,.5);
  color:#fff;
  padding:6px 10px;
  border-radius:10px;
  font-size:14px;
}
#ui span{margin:0 6px}
#overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  align-items:center;
  justify-content:center;
}
.panel{
  background:#1f2937;
  color:#fff;
  padding:16px;
  border-radius:12px;
  width:90%;
  max-width:320px;
  text-align:center;
}
button{
  background:#2563eb;
  border:none;
  color:#fff;
  padding:6px 10px;
  margin:4px;
  border-radius:6px;
}
canvas{display:block}
</style>
</head>
<body>

<div id="ui">
‚ù§Ô∏è <span id="hp"></span>
‚öîÔ∏è <span id="atk"></span>
üí∞ <span id="gold"></span>
üåä <span id="wave"></span>
‚è± <span id="time"></span>s
</div>

<canvas id="c"></canvas>

<div id="overlay">
  <div class="panel" id="panel"></div>
</div>

<script>
/* ---------- SETUP ---------- */
const c = document.getElementById("c");
const ctx = c.getContext("2d");
resize();
window.addEventListener("resize", resize);

function resize(){
  c.width = window.innerWidth;
  c.height = window.innerHeight;
}

const TILE = 32;
const VIEW = 20;

/* ---------- PLAYER ---------- */
let player = {
  x:0,y:0,
  px:0,py:0,
  hp:100,maxHp:100,
  atk:6,
  gold:0,
  speed:2.2,
  regen:0.01
};

/* ---------- WORLD ---------- */
function tile(x,y){
  let n = Math.sin(x*12.989+y*78.233)*43758.5453;
  n = n-Math.floor(n);
  if(n<0.1) return "water";
  if(n<0.2) return "rock";
  return "grass";
}

/* ---------- MONSTERS ---------- */
let monsters=[];
let wave=1;

function spawnMonster(){
  monsters.push({
    x:player.x+(Math.random()*600-300),
    y:player.y+(Math.random()*600-300),
    hp:30+wave*10,
    maxHp:30+wave*10,
    atk:4+wave,
    speed:0.8+Math.random()*0.6,
    cd:0
  });
}
for(let i=0;i<5;i++) spawnMonster();

/* ---------- INPUT ---------- */
let keys={};
document.addEventListener("keydown",e=>keys[e.key]=true);
document.addEventListener("keyup",e=>keys[e.key]=false);

/* ---------- SHOP ---------- */
function openShop(){
  show(`
  <h3>–ú–∞–≥–∞–∑–∏–Ω</h3>
  üíâ HP +20 ‚Äî 20üí∞<br><button onclick="buyHP()">–ö—É–ø–∏—Ç—å</button><br><br>
  ‚öîÔ∏è –£—Ä–æ–Ω +2 ‚Äî 30üí∞<br><button onclick="buyATK()">–ö—É–ø–∏—Ç—å</button><br><br>
  ‚ù§Ô∏è –†–µ–≥–µ–Ω ‚Äî 40üí∞<br><button onclick="buyRegen()">–ö—É–ø–∏—Ç—å</button><br><br>
  <button onclick="close()">–ó–∞–∫—Ä—ã—Ç—å</button>
  `);
}
function buyHP(){ if(player.gold>=20){player.gold-=20;player.maxHp+=20;player.hp+=20;} }
function buyATK(){ if(player.gold>=30){player.gold-=30;player.atk+=2;} }
function buyRegen(){ if(player.gold>=40){player.gold-=40;player.regen+=0.02;} }

/* ---------- UI ---------- */
function show(t){ overlay.style.display="flex"; panel.innerHTML=t; }
function close(){ overlay.style.display="none"; }

/* ---------- GAME LOOP ---------- */
let start = Date.now();
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();

function update(){
  // time
  document.getElementById("time").textContent =
    Math.floor((Date.now()-start)/1000);

  // move player
  let dx=0,dy=0;
  if(keys["a"]||keys["ArrowLeft"])dx--;
  if(keys["d"]||keys["ArrowRight"])dx++;
  if(keys["w"]||keys["ArrowUp"])dy--;
  if(keys["s"]||keys["ArrowDown"])dy++;
  let len=Math.hypot(dx,dy)||1;
  player.x+=dx/len*player.speed;
  player.y+=dy/len*player.speed;

  // regen
  player.hp=Math.min(player.maxHp,player.hp+player.regen);

  // monsters
  monsters.forEach(m=>{
    let dx=player.x-m.x, dy=player.y-m.y;
    let d=Math.hypot(dx,dy);
    if(d>5){
      m.x+=dx/d*m.speed;
      m.y+=dy/d*m.speed;
    }
    // auto attack player
    if(d<24 && m.cd<=0){
      player.hp-=m.atk;
      m.cd=60;
    }
    if(m.cd>0)m.cd--;
    // auto attack monster
    if(d<28){
      m.hp-=player.atk*0.02;
    }
  });

  // deaths
  monsters=monsters.filter(m=>{
    if(m.hp<=0){
      player.gold+=10;
      return false;
    }
    return true;
  });

  if(monsters.length<5+wave){
    spawnMonster();
  }

  // UI
  hp.textContent=Math.floor(player.hp)+"/"+player.maxHp;
  atk.textContent=player.atk;
  gold.textContent=player.gold;
  wave.textContent=wave;
}

/* ---------- DRAW ---------- */
function draw(){
  ctx.clearRect(0,0,c.width,c.height);
  let cx=Math.floor(player.x/TILE);
  let cy=Math.floor(player.y/TILE);

  for(let y=-VIEW;y<VIEW;y++){
    for(let x=-VIEW;x<VIEW;x++){
      let t=tile(cx+x,cy+y);
      if(t==="grass")ctx.fillStyle="#4ade80";
      if(t==="rock")ctx.fillStyle="#a3a3a3";
      if(t==="water")ctx.fillStyle="#38bdf8";
      ctx.fillRect(
        c.width/2+(x*TILE)-(player.x%TILE),
        c.height/2+(y*TILE)-(player.y%TILE),
        TILE,TILE
      );
    }
  }

  // player
  ctx.fillStyle="#fde68a";
  ctx.fillRect(c.width/2-6,c.height/2-10,12,12);
  ctx.fillStyle="#2563eb";
  ctx.fillRect(c.width/2-8,c.height/2+2,16,16);

  // monsters
  monsters.forEach(m=>{
    let sx=c.width/2+(m.x-player.x);
    let sy=c.height/2+(m.y-player.y);
    ctx.fillStyle="#dc2626";
    ctx.fillRect(sx-8,sy-8,16,16);
    ctx.fillStyle="#22c55e";
    ctx.fillRect(sx-10,sy-14,(m.hp/m.maxHp)*20,3);
    ctx.fillStyle="#fff";
    ctx.fillText(Math.floor(m.hp),sx-6,sy-16);
  });
}

document.addEventListener("dblclick",openShop);
</script>
</body>
</html>
